[toc]



# 类加载过程

在Java程序运行过程中，如果要使用的某个类不在内存里，则必须先把Class文件加载进内存。这个过程可以分为加载，连接和初始化，其中连接又分为验证，准备，解析三个过程。在类使用完以后还会被卸载。

## 加载

JVM通过类的全限定名获取该类的二进制字节流并把它加载到方法区，还会在内存里生成类对应的java.lang.class对象。其中获取二进制字节流可能是从编译好的class文件中获取，还有一些其他途径。比如从jar包获取，从网络上获取(Web Applet)以及运行时计算生成(动态代理)等等。

## 验证

验证是为了保护JVM的安全。因为二进制字节流的来源有很多，尽管java从语言层面限制了许多操作，如不允许数组越界访问，否则编译会抛出异常，但是许多java代码层面无法做到的事情可以通过直接编辑字节码实现，所以必须对字节码做校验来保护JVM。

* 文件格式校验，这个过程是校验class文件是否符合规范，比如魔数是否以0xCAFEBABE开头，版本号是否被JVM接受等等。
* 元数据校验，这个过程会对类的元数据信息进行语义校验，比如类是否继承了final修饰的类，子类是否和父类产生矛盾，非抽象类是否实现了父类或接口要求实现的所有方法等等。
* 字节码校验，这是最复杂的一个阶段，主要是通过数据流和控制流分析，确认程序语义是否合法。如变量赋值和类型转换是否合法，指令跳转是否跳转到方法体以外的字节码上了。但是即使程序通过了字节码校验，也不能保证程序一定是安全的。这涉及到计算机理论的一个悖论，“停机问题”，即不可能通过程序去校验另一个程序是否安全。
* 符号引用校验，这个过程会发生在解析阶段，可见，类加载时，这些阶段可能会交叉进行。这个阶段是校验通过符号引用是否能找到对应的直接引用，符号引用是变量或者方法的名字，直接引用是对应的地址或句柄。

其实验证阶段并非是必须的，比如一份代码，已经在机器上运行了很多次，现在把它部署到其它机器上时，就可以考虑使用-Xverify:none参数来关闭验证，以缩短类加载时间。

# 准备




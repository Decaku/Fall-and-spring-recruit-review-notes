# 消息顺序

Kafka只保证每个partion内的消息是有序的，如果要求全局消息一致那只能使用一个partion，这无疑会降低吞吐量。

一般来说只要业务上消息局部有序即可，比如一个userId对应的消息应该顺序消费。Kafka在sendMsg的时候可以指定topic，partion,key，那么我们让key=userId即可，因为key相同的消息会被hash后发送到相同的partion里。（那又引入了hash一致性的问题）。

同时在这种场景下sendMsg应该同步发送，异步发送注册回调函数这种做法会遇到这样的问题，发送消息1，2，3，消息2发送失败，回调函数重试后重新发送消息2成功，那么partion里储存的消息顺序实际上是1，3，2,不再有序。



# 重平衡

发生重平衡的时机有三个

* 消费者组中消费者的数量发生变化，有新的消费者加入或有消费者离开
* 订阅的主题数量变化
* 订阅的主题的分区数量变化

重平衡的时候会触发STW，消费者组下所有消费者必须停止服务。

本质上，重平衡是让消费者组下的所有消费者就如何消费分区达成共识。

实际上，重平衡需要配合broker伤的Coordinate服务来使用，这其实充当了一个协调者，（判断消费者是否挂掉，维护offset）在早期的kafka版本里协调者是zookeeper，但是由于zookeeper不适合频繁写，于是kafka内置了一个协调者，coordinate本质上也是一个topic。

consumer会定期向coordinate发送心跳包，如果coordinate超过预期的时间没有收到心跳包，就会判定consumer已死。心跳线程一般会和消费线程分开，否则消费者消费消息时间过长，就会使心跳包来不及发送，从而coordinate错误判定消费者已死，产生重平衡。

最新版本的kafka采取了渐进式重平衡协议，在reblance的时候不需要释放所有的资源，而是对当前资源登记然后渐近修改，这样在reblance的时候consumer可以继续运行。




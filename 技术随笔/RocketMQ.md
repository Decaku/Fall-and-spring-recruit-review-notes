RocketMQ可以保证业务数据的强一致性。

# 事务消息

考虑一个分布式微服务的场景。用户下单支付以后，先调用订单服务更新订单的数据库，然后发送消息到MQ，支付模块拉取消息消费扣款。但是这两个服务有可能出现一个成功一个失败的情况，导致数据不一致。

一种解决思路：

``` java
// 开始事务
try {
  // 1.执行数据库操作
  // 2.发送 mq 消息
  // 3.提交事务
}catch (Exception e){
  // 4.回滚事务
}

```



把MQ操作写在事务里。并且当mq发送失败时进行重试（这里可能会出现客户端发送消息成功但是没有收到mq的ACK，导致客户端认为发送失败回滚事务的情况，所以第二步必须保证成功）。但是把消息发送耦合在事务里，出现失败多次重试，会增加事务持有锁的时间，影响数据库的吞吐量。



我们可以利用MQ提供的事务消息来解决这个问题。

刚开始客户端会向MQ服务端提交一个半消息，MQ把消息持久化到本地，这个消息暂时对消费者是不可见的。然后客户端开始执行数据库事务（订单服务），并提交事务成功/回滚的消息给MQ,事务成功后消费者就可以对之前提交给MQ的消息消费（支付消息）。如果二次提交消息失败，RocketMQ还提供了一个消息反查的机制，通过注册回调接口来反查事务状态。



**reference link:https://juejin.cn/post/6844904106532962311** 

